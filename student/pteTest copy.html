<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="css/practiceExam.css">
    <link rel="stylesheet" href="css/style.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <link rel="stylesheet" href="css/style_for_mycourse_dropdown.css">
    <link rel="stylesheet" href="css/font-awesome.min.css">
    <link rel="stylesheet" href="css/bootstrap.css">
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/custome.css">
    <link rel="stylesheet" href="css/pteTest.css">
    
</head>
<body>
    <nav id="main-navbar" class="navbar1 fixed-top" style="position: fixed;">
        <a id="toggle-btn" href="javascript:void(0);" onclick="" class="link-dark">
            <img class="logo_icon" src="images/LMS_icon.png" />
            <div href="" class="logo_name text-decoration-none"><span>PTE Mock Test</span></div>
        </a>
    </nav>
    
    <div style="margin-top: 80px">
        
        <!--Section 01 (this section Displayed main banner image)-->
        <section class="banner-area relative about-banner" id="home" style="background: url('images/img/slider3.png') right;">	
            <div class="overlay overlay-bg" style="background-color: rgba(0, 65, 65, 0.5);"></div>
            <div class="container">				
                <div class="row d-flex align-items-center justify-content-center">
                    <div class="about-content col-lg-12"></div>	
                </div>
            </div>
        </section>

        <!--Section 03 (This section is used for recording and submiting answers)-->
    <section class="feature-area" id="block">
        <div class="container">
            <div class="row" >
                <div class="col-md-12" >
                    <div class="feature-area" id="feature-area">
                        <div class="single-feature" id="single-feature">
                            <div class="title" id="title" style="height: auto; text-align: justify; padding: 15px;"></div>
                            <div class="desc-wrap" style="background-color: rgb(218, 253, 253); ">
                               
                                <!--************************************************************************************************************-->
                                <!--timer row-->
                                <div id="timer_row" class="row">
                                    <div id="prepair-time" class="col-2 col-md-3 col-sm-4">
                                        <div style="color: red;">Prepair Time</div>
                                        <div id="prepair-timer" style="color: red;">00:00:00</div>
                                    </div>
                                    <div id="recording-bar" class="col-8 col-md-6 col-sm-4">
                                        <div class="progress">
                                            <div id="myProgressBar" class="progress-bar progress-bar-striped" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                                        </div>
                                    </div>
                                    <div id="recording-time" class="col-2 col-md-3 col-sm-4">
                                        <div data-role="controls">
                                            <div id="timer">00:00:00</div>
                                        </div>
                                        <button id="recordButton" style="display: none;">Record</button>
                                        <div data-role="recordings"></div>
                                    </div>
                                </div>  

                                <!--************************************************************************************************************-->
                                <!--question and recording row-->
                                <div id="qandr_row" class="row px-5">
                                    <div id="solution" style="text-align: justify; justify-content: center; align-items: center; display: flex; color: #222; margin-top: 25px; padding-left: 30px; padding-right: 30px;">
                                            
                                    </div>    
                                </div>

                                <!--************************************************************************************************************-->    
                                <!--text row-->
                                <div id="text_row" class="row px-5" style="margin-top: 60px; display: none;">
                                    <textarea name="" id="text_answer" cols="30" rows="10"></textarea>
                                </div>

                                <!--************************************************************************************************************-->
                                <!--button row-->      
                                <div id="button_row" class="row" style="margin-top: 60px;">
                                    <div class="col-2 col-md-3 col-sm-4">
                                        <a  href="#" id="save_and_exit" style="font-size: 18px; font-weight:600; float: left;">Save and Exit</a>
                                    </div>
                                    <div class="col-8 col-md-6 col-sm-4">
                                        <a id="page-number" style="font-size: 18px; font-weight:600;"><span id="currentPage">1</span> /<span id="totalPages">1</span></a>
                                    </div>
                                    <div class="col-2 col-md-3 col-sm-4">
                                        <a  href="#" id="next" style="font-size: 18px; font-weight:600; float: right;">Next</a>	
                                    </div>
                                </div>
                            </div>    
                            </div>
                        </div>
                    </div>
                </div>
         	 </div>
        </div>	
    </section>
    </div>

    <div id="popup" class="popup">
        <div class="popup-card" style="width: 30rem;">
            <div class="card-body">
                <h5 class="card-title"></h5>
                <p class="card-text"></p>
                <div class="btn-section"></div>
            </div>
        </div>
    </div> 



<script>

    $(document).ready(function (){
    //test page message received function
     $(window).on('message', function(event) {

      if (event.originalEvent.source === window.opener) {
  

        //get the test_id
        var fragment = window.location.hash;
        if (fragment.startsWith('#')) { var test_id = parseInt(fragment.substring(1)); } 
        
        //assign the html DOM
        var progressBar = document.getElementById('myProgressBar');
        const toggleRecordingButton = $('#recordButton');
        const audioPlayer = $('#audioPlayer');

        //assign the pagination variable data
        var currentPage = 1;
        var questionsPerPage = 1;

        //define the question or answers variable
        let question_id;
        let type;
        let prepairTime;
        var pageNumber;


        // starting popup message
        $("#popup").fadeIn(400,function() {
            $('.card-title').text('Test Resumed')
            $('.card-text').text('Click "Continue" to start the test.')
            $('.btn-section').append(`
                <a id="starting-continue" href="#"  class="btn btn-primary float-center me-3">Continue</a>
            `)
        });

        //continue button
        $(document).on('click', '#starting-continue', function(event) {
            $('#popup').fadeOut()
            $('#starting-continue').remove() 
            fetchAndDisplayQuestions(currentPage)
        })

        //fetch the start page number
        $.ajax({
            url: `src/controllers/getController.php?data_type=startPage&test_id=${test_id}`,
            method: 'GET',
            success: function(data){ pageNumber = data['start_page'] }
        })


        /*******************************************************************************************************************
        ************************************** FETCHING DATA FROM DB *******************************************************
        *******************************************************************************************************************/

        function fetchAndDisplayQuestions(page){
            $.ajax({
                url: `src/controllers/getController.php?data_type=questionDisplay&page=${page}&per_page=${questionsPerPage}&test_id=${test_id}&type=${null}`,
                method: 'GET',
                success: function(data){

                    isRecording = false;
                    prepairTime = false;

                    // DOM value clearing
                    $('#title').empty();
                    $('#Question').empty();
                    $('#solution').empty();

                    //assign the variable from database
                    totalPages = data['totalItems'].Count;
                    

                    console.log(data)

                    for (var i = 0; i < data['data'].length; i++) {

                        //assign the variable from database
                        type = data['data'][i].type;
                        Solution = data['data'][i].solution;
                        type = data['data'][i].type;
                        KeyWords = data['data'][i].key_words
                        question_id = data['data'][i].question_id;

                        //title DOM Create
                        var mainStyles = $('#solution').attr('style');
                        $('#title').append(`<h4 style="color: white;">${data['data'][i].question}</h2>`);


                        if(type == 'Read Aloud'){ 
        //------> Read Aloud
                            resetTimer(2)
                            startTimer(2)

                            $('#solution').attr('style', mainStyles);
                            $('#solution').append(`<p>${data['data'][i].solution}</p>`);
                        }else if(type === 'Repeat Sentence' || type === 'Re-tell Lecture' || type == 'Answer Short Question'){
        //------> Repeate Sentence, Re-tell Lecture and Answer Short Question
                            resetTimer(3)
                            startTimer(3)

                            $('#solution').attr('style', mainStyles);
                            $('#solution').append(`
                                <audio id = "questionAudio" controls style="width: 400px; margin: 50px">
                                    <source src="${data['data'][i].audio}" type="audio/mpeg">
                                    Your browser does not support the audio element.
                                </audio>`
                            );
                        }else if(type == 'Describe Image'){
        //------> Describe Image
                            resetTimer(4)
                            startTimer(4)

                            $('#solution').attr('style', mainStyles);
                            $('#solution').append(`<img src="${data['data'][i].imageFile}" style="width:300px; height: 200px">`);
                        }else if(type == 'Summarize Written Text' || type == 'Write Essay'){ 
        //------> Summarize Written Test, Write Essay
                            resetTimer(5)
                            startTimer(5)

                            $('#solution').removeAttr('style');
                            $('#solution').css('text-align', 'justify')
                            $('#text_row').css('display','block')
                            $('#prepair-time').empty()
                            $('#timer_row').css('margin-bottom', '20px')

                            var paragraphsArray = Solution.split('"=,');
                            paragraphsArray = paragraphsArray.map(function(paragraph) {
                                return paragraph.trim();
                            });
                            console.log(paragraphsArray)
                            for (var i = 0; i < paragraphsArray.length; i++) {
                                $('#solution').append('<p>' + paragraphsArray[i] + '</p>');
                            }
                        }   

                    }
                    function updatePagination() {
                        $("#currentPage").text(pageNumber);
                        $("#totalPages").text(totalPages);
                    }
                    updatePagination()
                    
                }
            })
        }



        // next button popup message
        $("#next").on("click", function() {
            if(type == 'Summarize Written Text' || type == 'Write Essay'){
                $("#popup").fadeIn(400,function() {
                    //$('#cancel').css('display','none')
                    $('.card-title').text('Confirm')
                    $('.card-text').text('Are you it you want to submit this answer this answer and go to the next question?')
                    $('.btn-section').append(`
                        <a id="yes-popup" href="#"  class="btn btn-primary float-center me-3">YES</a>
                        <a id="no-popup" href="#" data-recording = 1  class="btn btn-primary float-center me-3">NO</a>
                    `)
                });
            }else{
                prepairTime = !prepairTime
                RecordingButton()
            }            
        });

        //Yes button
        $(document).on('click', '#yes-popup', function(event) {
            
            stopTimer()

            if(type == 'Summarize Written Text' || type == 'Write Essay'){
                submit()
            }else{
                stopRecording();
            }

            $('.btn-section').empty()
            $('.card-title').empty()
            $('.card-text').empty()
            $("#popup").fadeOut();


            $("#popup").fadeIn(400,function() {
                $('.card-title').text('Waiting.........')
                $('.btn-section').append(`
                <div class="d-flex justify-content-center">
                    <div class="spinner-border" role="status" style="width: 5rem; height: 5rem;">
                        <span class="sr-only">Loading...</span>
                    </div>
                </div>
                `)
                
            });

        })

        //No button
        $(document).on('click', '#no-popup', function(event) {
            $('.btn-section').empty();
            $('.card-title').empty();
            $('.card-text').empty();
            $("#popup").fadeOut();           
        });



        //invisible recording button function
        
        function RecordingButton() {
            if (!isRecording) {
                if(prepairTime){
                    resetTimer(1)
                    stopTimer()
                    startTimer(1)//--> recording timer
                    startRecording();
                    isRecording = !isRecording;
                }else {
                    stopTimer()
                    $("#popup").fadeIn(400,function() {
                        //$('#cancel').css('display','none')
                        $('.card-title').text('Cannot Skip')
                        $('.card-text').text('You need to finish answering this question before going to the next.')
                        $('.btn-section').append(`
                            <a id="close-popup" href="#" data-recording = 0  class="btn btn-primary float-center me-3">Close</a>
                        `)
                    });
                }
            } else {
                if(prepairTime){
                    //pauseRecording()
                    //stopTimer()
                    $("#popup").fadeIn(400,function() {
                        //$('#cancel').css('display','none')
                        $('.card-title').text('Confirm')
                        $('.card-text').text('Are you it you want to submit this answer this answer and go to the next question?')
                        $('.btn-section').append(`
                            <a id="yes-popup" href="#"  class="btn btn-primary float-center me-3">YES</a>
                            <a id="no-popup" href="#" data-recording = 1  class="btn btn-primary float-center me-3">NO</a>
                        `)
                    });
                }else {
                    stopTimer()
                    stopRecording()
                    $("#popup").fadeIn(400,function() {
                        //$('#cancel').css('display','none')
                        $('.card-title').text('Recording Stoped')
                        $('.card-text').text('Please click "Next" to go to the next question')
                        $('.btn-section').append(`
                            <a id="yes-popup" href="#"  class="btn btn-primary float-center me-3">Next</a>
                        `)
                    });
                    isRecording = !isRecording;
                }
            }
        };



        //close-popup for cannot skip popup
        $(document).on('click', '#close-popup', function(event) {
            $('.btn-section').empty()
            $('.card-title').empty()
            $('.card-text').empty()
            $("#popup").fadeOut();
            if(type == 'Read Aloud'){
                startTimer(2)
            }else if(type === 'Repeat Sentence' || type === 'Re-tell Lecture' || type == 'Answer Short Question'){
                startTimer(3)
            }else if(type == 'Describe Image'){
                startTimer(4)
            }
            
            
        });





        //after click the save and exit button this function load
        function closeAndMoveToPreviousTab() {
            $.ajax({
                url:'src/controllers/postController.php',
                type: 'POST',
                data: { task : 'incomplete_test', test_id :  test_id},
                success: function(response){
                    window.close();
                    window.history.back();
                    
                }
            })

            
            
        }

        //click the save and exit button
        $('#save_and_exit').on('click', function() {
            closeAndMoveToPreviousTab();
            const replyMessage = 'Reload';
            event.originalEvent.source.postMessage(replyMessage, '*');

        });


        /*******************************************************************************************************************
        ************************************** Timming Function *******************************************************
        *******************************************************************************************************************/

        //assign the variables of time
        let seconds1 = 0;
        let seconds2 = 35;
        let seconds3 = 5;
        let seconds4 = 25;
        let seconds5 = 0;
        let minutes = 0;
        let hours = 0;

        function startTimer(task) {
            prepairTime = !prepairTime
            timer = setInterval(function(){updateTimer(task)}, 1000);
        }

        function stopTimer() {
            clearInterval(timer);
        }

        function resetTimer(task) {             
            clearInterval(timer);
            if(task==1){
                seconds1 = 0;
                progressBar.style.width = 0+'%'
            }else if(task == 2){
                seconds2 = 35;
            }else if(task == 3){
                seconds3 = 5;
            }else if(task == 4){
                seconds4 = 25;
            }else if(task == 5){
                seconds5 = 0;
            }
            minutes = 0;
            hours = 0;
            updateTimerDisplay(task);
        }

        function updateTimer(task) {
            if(task==2){
                seconds2--;
                if (seconds2 === 30) {
                    clearInterval(timer);
                    RecordingButton();  
                }
                    
            }else if(task==3){
                seconds3--;
                if (seconds3 === 0) {
                    clearInterval(timer);
                    playAudio();
                }
                    
            }else if(task==4){ 
                seconds4--;
                if (seconds4 === 0) {
                    clearInterval(timer);
                    RecordingButton(); 
                }
                    
            }else if(task==1){
                //this is progress increasing
                var currentWidth = parseFloat(progressBar.style.width, 10);
                var newWidth = (currentWidth + 2.5) % 101; 
                progressBar.style.width = newWidth + '%';
                                         
                seconds1++;
                if (seconds1 === 40) {
                    clearInterval(timer);
                    RecordingButton();
                }
            }else if(task==5){
                //this is progress increasing
                var currentWidth = parseFloat(progressBar.style.width, 10);
                var newWidth = (currentWidth + 0.16) % 101; 
                progressBar.style.width = newWidth + '%';
                
                seconds5++;
                if (seconds5 >= 60) {
                    seconds5 = 0;
                    minutes++;
                    
                    if (minutes >= 10) {
                        clearInterval(timer);
                    }
                }
                
                
            }
            updateTimerDisplay(task);
        }

        function updateTimerDisplay(task) { 
            if(task==1){
                const formattedTime = `${pad(hours)}:${pad(minutes)}:${pad(seconds1)}`;
                $("#timer").text(formattedTime);
            }else if(task==2){
                const formattedTime = `${pad(hours)}:${pad(minutes)}:${pad(seconds2)}`;
                $("#prepair-timer").text(formattedTime);
            }else if(task==3){
                const formattedTime = `${pad(hours)}:${pad(minutes)}:${pad(seconds3)}`;
                $("#prepair-timer").text(formattedTime);
            }else if(task==4){
                const formattedTime = `${pad(hours)}:${pad(minutes)}:${pad(seconds4)}`;
                $("#prepair-timer").text(formattedTime);
            }else if(task==5){
                const formattedTime = `${pad(hours)}:${pad(minutes)}:${pad(seconds5)}`;
                $("#timer").text(formattedTime);
            }
        }

        function pad(value) {
            return value < 10 ? `0${value}` : value;
        }


        /*******************************************************************************************************************
        ************************************** Audio Play *******************************************************
        *******************************************************************************************************************/


        function playAudio() {
            var questionAudio = $('#questionAudio')[0];

            if (questionAudio) {
                questionAudio.removeEventListener('loadedmetadata', handleMetadataLoaded);
                questionAudio.addEventListener('loadedmetadata', handleMetadataLoaded);

                if (questionAudio.readyState >= 2) {
                    questionAudio.dispatchEvent(new Event('loadedmetadata'));
                }

                questionAudio.play();
            } else {
                console.error("Audio element not found");
            }
        }

        function handleMetadataLoaded() {
            var duration = $('#questionAudio')[0].duration;
            console.log("Audio duration: " + duration + " seconds");

            recordingTimeout = setTimeout(function () {
                RecordingButton();;
            }, duration * 1000);
        }

        function stopRecordingTimeout() {
            if (recordingTimeout) {
                clearTimeout(recordingTimeout);
            }
        }

        function stopAudio(){
            var questionAudio = $('#questionAudio')[0];
            questionAudio.pause()
            questionAudio.currentTime = 0
            stopRecordingTimeout()
        }


        /*******************************************************************************************************************
        ************************************** Recording Section *******************************************************
        *******************************************************************************************************************/

        let audioChunks = [];


        function startRecording() {
            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(function (stream) {
                    mediaRecorder = new MediaRecorder(stream);

                    mediaRecorder.ondataavailable = function (event) {
                        if (event.data.size > 0) {
                            audioChunks.push(event.data);
                        }
                    };

                    mediaRecorder.onstop = function () {
                        const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                        const audioUrl = URL.createObjectURL(audioBlob);
                        audioPlayer.attr('src', audioUrl);
                        console.log(audioUrl)
                        const formData = new FormData();
                        formData.append('audio', audioBlob, 'recording.wav');
                        formData.append('task','save_audio');

                        // Send the recorded audio to the server using $.ajax or $.post
                        saveAudio(formData);

                        audioChunks = [];
                    };

                    mediaRecorder.start();
                    toggleRecordingButton.prop('disabled', false);
                })
                .catch(function (error) {
                    console.error('Error accessing microphone:', error);
                });
        }


        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
            }
        }

        function pauseRecording() {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.pause();
            }
        }

        function saveAudio(formData) {
            // Send the recorded audio data to the server using $.ajax or $.post
            $.ajax({
                url: 'src/controllers/postController.php',
                method: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function (response) {
                    console.log('Audio saved successfully:');
                    console.log(response.audioFile2);
                    audioFile = response.audioFile2;
                    submit()
                },
                error: function (error) {
                    console.error('Error saving audio:', error);
                }
            });
        }



        function submit(){
            answer = $('#text_answer').val();

            console.log('Question No:' + question_id)
            if(type == 'Read Aloud' || type == 'Repeat Sentence'){
                task = 'normal_scoring'
                data = { task : task, Solution: Solution, question_id: question_id, student_id: 2, key_words: KeyWords, type: type, test_id: test_id}
            }else if(type == 'Describe Image' || type == 'Re-tell Lecture' || type == 'Answer Short Question'){
                task = 'advanced_scoring'
                data = { task : task, Solution: Solution, question_id: question_id, student_id: 2, key_words: KeyWords, type: type, test_id: test_id}
            }else if(type == 'Summarize Written Text'){
                task = 'writing_marks'
                data = { task : task, Solution: Solution, answer: answer, question_id: question_id, student_id: 2, key_words: KeyWords, type: type, test_id: test_id}
            }else if(type == 'Write Essay'){
                task = 'essay_write';
                data = { task : task, Solution: Solution, answer: answer, question_id: question_id, student_id: 2, key_words: KeyWords, type: type, test_id: test_id} 
            }

            $.ajax({
                url:'src/controllers/postController.php',
                type: 'POST',
                data: data,
                success: function(response){
                    $("#popup").fadeOut();
                    $('.btn-section').empty()
                    $('.card-title').empty()
                    $('.card-text').empty()
                    $('#next-popup').remove(); 
                    const replyMessage = 'Reload';
                    event.originalEvent.source.postMessage(replyMessage, '*');
                    console.log(response.message);
                    if(response.success){
                        if (pageNumber < totalPages) {
                            pageNumber++;
                            fetchAndDisplayQuestions(currentPage);
                            resetTimer(1);
                            resetTimer(1)
                            if(type == 'Read Aloud'){ 
                                resetTimer(2)
                            }else if(type === 'Repeat Sentence' || type === 'Re-tell Lecture' || type == 'Answer Short Question'){
                                resetTimer(3)
                            }else if(type == 'Describe Image'){
                                resetTimer(4)
                            }else if(type == 'Summarize Written Text' || type == 'Write Essay'){ 
                                resetTimer(5)
                            }   
                        }else{
                            $.ajax({
                                url:'src/controllers/postController.php',
                                type: 'POST',
                                data: { task : 'complete_test', test_id :  test_id},
                                success: function(response){
                                    window.close();
                                    window.history.back();
                                }
                            })
                        } 
                        
                    }else{
                        $("#popup").fadeIn(400,function() {
                            //$('#cancel').css('display','none')
                            $('.card-title').text('Notice Error')
                            $('.card-text').text('The answer was not saved due to an internet problem or a problem recording your voice')
                            $('.btn-section').append(`
                                <a id="save_and_exit_popup" href="#"  class="btn btn-primary float-center me-3">Save and Exit</a>
                                <a id="retry" href="#"  class="btn btn-danger float-center me-3">Retry</a>

                            `)
                        });

                        $(document).on('click', '#save_and_exit_popup', function(event) {
                            $('.btn-section').empty()
                            $('.card-title').empty()
                            $('.card-text').empty()
                            closeAndMoveToPreviousTab();
                        });

                        $(document).on('click', '#retry', function(event) {
                            resetTimer(1)
                            if(type == 'Read Aloud'){ 
                                resetTimer(2)
                                startTimer(2)
                            }else if(type === 'Repeat Sentence' || type === 'Re-tell Lecture' || type == 'Answer Short Question'){
                                resetTimer(3)
                                startTimer(3)
                            }else if(type == 'Describe Image'){
                                resetTimer(4)
                                startTimer(4)
                            }else if(type == 'Summarize Written Text' || type == 'Write Essay'){ 
                                resetTimer(5)
                                startTimer(5)
                            }  
                            $('.btn-section').empty()
                            $('.card-title').empty()
                            $('.card-text').empty() 
                            $("#popup").fadeOut();
                            
                            //reset the timinig and recording features
                            isRecording = false
                            prepairTime = true
                        });

                    }
                    
                }
            })
                
        };


        
       }
     })

    })
</script>
    
</body>
</html>